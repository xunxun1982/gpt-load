name: Build Docker Image

on:
  push:
    tags:
      - "*"

jobs:
  # Collect PGO profile for Docker builds
  collect-pgo-profile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.6"
          cache: true
          cache-dependency-path: go.sum

      - name: Make scripts executable
        run: chmod +x scripts/collect-pgo-profile.sh

      - name: Collect PGO profile
        run: |
          echo "üîç Collecting PGO profile for Docker builds..."
          ./scripts/collect-pgo-profile.sh

          if [ ! -f "default.pgo" ]; then
            echo "‚ùå Failed to generate PGO profile"
            exit 1
          fi

          echo "‚úÖ PGO profile generated successfully"
          ls -lh default.pgo

      - name: Upload PGO profile
        uses: actions/upload-artifact@v6
        with:
          name: pgo-profile-docker
          path: default.pgo
          retention-days: 1

  # Build AMD64 image on x86 runner
  build_amd64:
    name: Build AMD64 Image
    needs: collect-pgo-profile
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download PGO profile
        uses: actions/download-artifact@v7
        with:
          name: pgo-profile-docker
          path: .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            xunxun1982/gpt-load
            ghcr.io/${{ github.repository }}
          flavor: |
            latest=false
          tags: |
            type=ref,event=tag,suffix=-amd64
            type=raw,value=beta-amd64,enable=${{ contains(github.ref, '-beta') }}
            type=raw,value=latest-amd64,enable=${{ !contains(github.ref, '-') }}

      - name: Build and push AMD64 image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ github.ref_name }}
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,mode=max,scope=amd64

  # Build ARM64 image on native ARM64 runner (no QEMU needed)
  build_arm64:
    name: Build ARM64 Image
    needs: collect-pgo-profile
    runs-on: ubuntu-24.04-arm
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download PGO profile
        uses: actions/download-artifact@v7
        with:
          name: pgo-profile-docker
          path: .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            xunxun1982/gpt-load
            ghcr.io/${{ github.repository }}
          flavor: |
            latest=false
          tags: |
            type=ref,event=tag,suffix=-arm64
            type=raw,value=beta-arm64,enable=${{ contains(github.ref, '-beta') }}
            type=raw,value=latest-arm64,enable=${{ !contains(github.ref, '-') }}

      - name: Build and push ARM64 image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ github.ref_name }}
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,mode=max,scope=arm64

  # Create multi-arch manifest
  create_manifest:
    name: Create Multi-arch Manifest
    runs-on: ubuntu-latest
    needs: [build_amd64, build_arm64]
    permissions:
      packages: write
      contents: read
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # NOTE: Using tags instead of digests for simplicity.
      # Docker official docs recommend digest-based approach for immutability,
      # but it requires artifact upload/download between jobs which adds complexity.
      # Tag-based approach is sufficient for this use case since builds are atomic.
      - name: Create and push manifests
        run: |
          set -euo pipefail

          TAG="${{ github.ref_name }}"
          GHCR_REPO=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          for REPO in "xunxun1982/gpt-load" "${GHCR_REPO}"; do
            # Create version tag manifest
            docker buildx imagetools create -t "${REPO}:${TAG}" \
              "${REPO}:${TAG}-amd64" \
              "${REPO}:${TAG}-arm64"

            # Create beta or latest manifest based on tag pattern
            if [[ "${TAG}" == *"-beta"* ]]; then
              docker buildx imagetools create -t "${REPO}:beta" \
                "${REPO}:${TAG}-amd64" \
                "${REPO}:${TAG}-arm64"
            elif [[ "${TAG}" != *"-"* ]]; then
              docker buildx imagetools create -t "${REPO}:latest" \
                "${REPO}:${TAG}-amd64" \
                "${REPO}:${TAG}-arm64"
            fi
          done
